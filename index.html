<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f0f2f5;
        }

        .top-section {
            padding: 15px;
            background: #fff;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .shapes-toolbar {
            width: 100px;
            background: #fff;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
            position: relative;
        }

        .canvas-wrapper {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #mainCanvas {
            background: #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            max-width: 100%;
            max-height: 100%;
        }

        .shape-item {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            transition: transform 0.2s;
        }

        .shape-item:hover {
            transform: scale(1.05);
            border-color: #2196F3;
        }

        .form-row {
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .btn { min-width: 120px; }
    </style>
</head>
<body>
    <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="top-section">
        <div class="container-fluid">
            <div class="row form-row">
                <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
                <div class="col-auto">
                    <div class="input-group">
                        <input type="file" id="bgImageUpload" class="form-control" accept="image/*" hidden>
                        <button class="btn btn-outline-secondary" onclick="document.getElementById('bgImageUpload').click()">
                            <i class="fas fa-image"></i> Ø®Ù„ÙÙŠØ©
                        </button>
                    </div>
                </div>

                <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± -->
                <div class="col-auto">
                    <div class="input-group">
                        <input type="file" id="elementImageUpload" class="form-control" accept="image/*" hidden>
                        <button class="btn btn-outline-primary" onclick="document.getElementById('elementImageUpload').click()">
                            <i class="fas fa-plus"></i> ØµÙˆØ±Ø©
                        </button>
                    </div>
                </div>

                <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ -->
                <div class="col-auto">
                    <input type="text" id="fullName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§">
                </div>

                <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                <div class="col-auto btn-group">
                    <button onclick="addText()" class="btn btn-primary">
                        <i class="fas fa-text-height"></i> Ù†Øµ
                    </button>
                    <button onclick="saveImage()" class="btn btn-success">
                        <i class="fas fa-download"></i> Ø­ÙØ¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="main-container">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø´ÙƒØ§Ù„ -->
        <div class="shapes-toolbar">
            <div class="shape-item" data-type="rect" draggable="true">â¬œ</div>
            <div class="shape-item" data-type="circle" draggable="true">ğŸ”µ</div>
            <div class="shape-item" data-type="triangle" draggable="true">ğŸ”º</div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
        <div class="canvas-wrapper">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ -->
    <div class="modal fade" id="editModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                        <input type="text" id="editText" class="form-control">
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                            <input type="number" id="editFontSize" class="form-control" min="10" max="100">
                        </div>
                        <div class="col-6">
                            <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ø·</label>
                            <input type="color" id="editColor" class="form-control">
                        </div>
                        <div class="col-12">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                            <select id="editFont" class="form-select">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Tahoma">Tahoma</option>
                                <option value="Simplified Arabic">Simplified Arabic</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveTextChanges()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const canvas = new fabric.Canvas('mainCanvas', {
            selection: true,
            preserveObjectStacking: true,
            allowTouchScrolling: true
        });

        let originalImage = null;
        let currentText = null;

        // Ø¥Ø¯Ø§Ø±Ø© Ø³Ø­Ø¨ Ø§Ù„Ø£Ø´ÙƒØ§Ù„
        document.querySelectorAll('.shape-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                e.dataTransfer.setData('text/plain', this.dataset.type);
            });
        });

        canvas.wrapperEl.addEventListener('dragover', e => e.preventDefault());
        
        canvas.wrapperEl.addEventListener('drop', e => {
            e.preventDefault();
            const type = e.dataTransfer.getData('text/plain');
            const rect = canvas.wrapperEl.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            addShape(type, x, y);
        });

        function addShape(type, x, y) {
            let shape;
            switch(type) {
                case 'rect':
                    shape = new fabric.Rect({
                        left: x,
                        top: y,
                        width: 100,
                        height: 60,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
                case 'circle':
                    shape = new fabric.Circle({
                        left: x,
                        top: y,
                        radius: 40,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
                case 'triangle':
                    shape = new fabric.Triangle({
                        left: x,
                        top: y,
                        width: 80,
                        height: 80,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
            }
            if (shape) {
                canvas.add(shape);
                canvas.setActiveObject(shape);
                canvas.requestRenderAll();
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±
        document.getElementById('bgImageUpload').addEventListener('change', e => loadImage(e.target.files[0], true));
        document.getElementById('elementImageUpload').addEventListener('change', e => loadImage(e.target.files[0], false));

        function loadImage(file, isBackground) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                fabric.Image.fromURL(e.target.result, img => {
                    if (isBackground) {
                        if (originalImage) canvas.remove(originalImage);
                        originalImage = img;
                        updateCanvasSize(img);
                        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    } else {
                        img.set({
                            left: canvas.width/2,
                            top: canvas.height/2,
                            hasControls: true,
                            borderColor: '#4CAF50',
                            originX: 'center',
                            originY: 'center'
                        });
                        canvas.add(img);
                        canvas.setActiveObject(img);
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        function updateCanvasSize(img) {
            const container = document.querySelector('.canvas-wrapper');
            const scale = Math.min(
                (container.clientWidth - 40) / img.width,
                (container.clientHeight - 40) / img.height
            );
            canvas.setDimensions({
                width: img.width * scale,
                height: img.height * scale
            });
            img.scale(scale);
            canvas.requestRenderAll();
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØµÙˆØµ
        function addText() {
            const text = document.getElementById('fullName').value.trim();
            if (!text) return;
            const textbox = new fabric.Textbox(text.toUpperCase(), {
                left: canvas.width/2,
                top: canvas.height/2,
                fontSize: 24,
                fontFamily: 'Arial',
                fill: '#000',
                hasControls: true,
                borderColor: '#2196F3',
                originX: 'center',
                originY: 'center'
            });
            canvas.add(textbox);
            canvas.setActiveObject(textbox);
            canvas.requestRenderAll();
        }

        // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¹Ù†Ø§ØµØ±
        document.addEventListener('keydown', e => {
            const obj = canvas.getActiveObject();
            if (!obj) return;
            const step = e.shiftKey ? 5 : 1;
            switch(e.key) {
                case 'ArrowUp': obj.top -= step; break;
                case 'ArrowDown': obj.top += step; break;
                case 'ArrowLeft': obj.left -= step; break;
                case 'ArrowRight': obj.left += step; break;
                case 'Delete': canvas.remove(obj); break;
            }
            canvas.requestRenderAll();
        });

        // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ
        canvas.on('mouse:dblclick', e => {
            if (e.target?.isType('textbox')) {
                currentText = e.target;
                document.getElementById('editText').value = currentText.text;
                document.getElementById('editFontSize').value = currentText.fontSize;
                document.getElementById('editColor').value = currentText.fill;
                document.getElementById('editFont').value = currentText.fontFamily;
                new bootstrap.Modal(document.getElementById('editModal')).show();
            }
        });

        function saveTextChanges() {
            currentText.set({
                text: document.getElementById('editText').value.toUpperCase(),
                fontSize: parseInt(document.getElementById('editFontSize').value),
                fill: document.getElementById('editColor').value,
                fontFamily: document.getElementById('editFont').value
            });
            canvas.requestRenderAll();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©
        function saveImage() {
            if (!originalImage) return alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
            const link = document.createElement('a');
            link.download = `design-${Date.now()}.png`;
            link.href = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2
            });
            link.click();
        }

        // ØªÙƒÙŠÙŠÙ Ø§Ù„Ø­Ø¬Ù… Ù…Ø¹ Ø§Ù„Ù†Ø§ÙØ°Ø©
        window.addEventListener('resize', () => {
            if (originalImage) updateCanvasSize(originalImage);
        });
    </script>
</body>
</html>
