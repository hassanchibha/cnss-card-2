<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø­Ø±Ø± Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: grey;
        }

        .top-section {
            padding: 15px;
            background: #fff;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #mainCanvas {
            background: #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin: auto;
        }

        .form-row {
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .btn { min-width: 120px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø´ÙƒØ§Ù„ */
        .shapes-toolbar {
            position: fixed;
            left: 20px;
            top: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            z-index: 1000;
        }

        .shape {
            padding: 8px;
            margin: 5px;
            cursor: move;
            border: 1px solid #ccc;
            border-radius: 3px;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø´ÙƒØ§Ù„ -->
    <div class="shapes-toolbar">
        <div class="shape" data-type="rect" draggable="true">â¬œ Ù…Ø³ØªØ·ÙŠÙ„</div>
        <div class="shape" data-type="circle" draggable="true">ğŸ”µ Ø¯Ø§Ø¦Ø±Ø©</div>
        <div class="shape" data-type="triangle" draggable="true">ğŸ”º Ù…Ø«Ù„Ø«</div>
    </div>

    <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="top-section">
        <div class="container-fluid">
            <div class="row form-row">
                <!-- Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ù„ÙÙŠØ© -->
                <div class="col-auto">
                    <div class="input-group">
                        <input type="file" id="bgImageUpload" class="form-control" accept="image/*" hidden>
                        <button class="btn btn-outline-secondary" onclick="document.getElementById('bgImageUpload').click()">
                            <i class="fas fa-image"></i> Ø®Ù„ÙÙŠØ©
                        </button>
                    </div>
                </div>

                <!-- Ø²Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± -->
                <div class="col-auto">
                    <div class="input-group">
                        <input type="file" id="elementImageUpload" class="form-control" accept="image/*" hidden>
                        <button class="btn btn-outline-primary" onclick="document.getElementById('elementImageUpload').click()">
                            <i class="fas fa-plus"></i> ØµÙˆØ±Ø©
                        </button>
                    </div>
                </div>

                <!-- Ø­Ù‚Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ -->
                <div class="col-auto">
                    <input type="text" id="fullName" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§">
                </div>

                <!-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
                <div class="col-auto btn-group">
                    <button onclick="addText()" class="btn btn-primary">
                        <i class="fas fa-text-height"></i> Ù†Øµ
                    </button>
                    <button onclick="saveImage()" class="btn btn-success">
                        <i class="fas fa-download"></i> Ø­ÙØ¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ -->
    <div class="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ -->
    <div class="modal fade" id="editModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Øµ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                        <input type="text" id="editText" class="form-control">
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ø·</label>
                            <input type="number" id="editFontSize" class="form-control" min="10" max="100">
                        </div>
                        <div class="col-6">
                            <label>Ù„ÙˆÙ† Ø§Ù„Ø®Ø·</label>
                            <input type="color" id="editColor" class="form-control">
                        </div>
                        <div class="col-12">
                            <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·</label>
                            <select id="editFont" class="form-select">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Tahoma">Tahoma</option>
                                <option value="Simplified Arabic">Simplified Arabic</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveTextChanges()">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const canvas = new fabric.Canvas('mainCanvas', {
            selection: true,
            preserveObjectStacking: true,
            allowTouchScrolling: true
        });

        let originalImage = null;
        let currentText = null;
        let isCtrlPressed = false;
        let isDragging = false;
        let clone = null;
        let draggedShapeType = null;

        // Ø£Ø­Ø¯Ø§Ø« Ø³Ø­Ø¨ Ø§Ù„Ø£Ø´ÙƒØ§Ù„
        document.querySelectorAll('.shape').forEach(shape => {
            shape.addEventListener('dragstart', e => {
                draggedShapeType = e.target.dataset.type;
            });
        });

        canvas.on('dragover', e => {
            e.e.preventDefault();
        });

        canvas.on('drop', e => {
            e.e.preventDefault();
            
            if (!draggedShapeType) return;
            
            const pointer = canvas.getPointer(e.e);
            let shape;
            
            switch(draggedShapeType) {
                case 'rect':
                    shape = new fabric.Rect({
                        left: pointer.x,
                        top: pointer.y,
                        width: 100,
                        height: 60,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
                    
                case 'circle':
                    shape = new fabric.Circle({
                        left: pointer.x,
                        top: pointer.y,
                        radius: 40,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
                    
                case 'triangle':
                    shape = new fabric.Triangle({
                        left: pointer.x,
                        top: pointer.y,
                        width: 80,
                        height: 80,
                        fill: '#f0f0f0',
                        stroke: '#333',
                        strokeWidth: 2
                    });
                    break;
            }
            
            if (shape) {
                canvas.add(shape);
                canvas.setActiveObject(shape);
                canvas.requestRenderAll();
            }
            
            draggedShapeType = null;
        });

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±ØŒ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØµÙˆØµØŒ etc...)
        document.getElementById('bgImageUpload').addEventListener('change', function(e) {
            loadImage(e.target.files[0], true);
        });

        document.getElementById('elementImageUpload').addEventListener('change', function(e) {
            loadImage(e.target.files[0], false);
        });

        function loadImage(file, isBackground) {
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                fabric.Image.fromURL(event.target.result, (img) => {
                    if (isBackground) {
                        if (originalImage) canvas.remove(originalImage);
                        originalImage = img;
                        updateCanvasSize(img);
                        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    } else {
                        img.set({
                            left: canvas.width/2,
                            top: canvas.height/2,
                            hasControls: true,
                            borderColor: '#4CAF50',
                            originX: 'center',
                            originY: 'center'
                        });
                        canvas.add(img);
                        canvas.setActiveObject(img);
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        function updateCanvasSize(img) {
            const container = document.querySelector('.canvas-container');
            const scale = Math.min(
                (container.clientWidth - 40) / img.width,
                (container.clientHeight - 40) / img.height
            );

            canvas.setDimensions({
                width: img.width * scale,
                height: img.height * scale
            });

            img.scale(scale);
            canvas.requestRenderAll();
        }

        function addText() {
            const textContent = document.getElementById('fullName').value.trim();
            if (!textContent) return;

            const text = new fabric.Textbox(textContent.toUpperCase(), {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontSize: 24,
                fontFamily: 'Arial',
                fill: '#000',
                hasControls: true,
                borderColor: '#2196F3',
                originX: 'center',
                originY: 'center'
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.requestRenderAll();
        }

        document.addEventListener('keydown', (e) => {
            const activeObject = canvas.getActiveObject();
            if (!activeObject) return;

            const moveStep = e.shiftKey ? 10 : 5;
            
            switch(e.key) {
                case 'ArrowUp': activeObject.top -= moveStep; break;
                case 'ArrowDown': activeObject.top += moveStep; break;
                case 'ArrowLeft': activeObject.left -= moveStep; break;
                case 'ArrowRight': activeObject.left += moveStep; break;
                case 'Delete': canvas.remove(activeObject); break;
            }
            
            canvas.requestRenderAll();
        });

        canvas.on('mouse:dblclick', (e) => {
            if (e.target?.isType('textbox')) {
                currentText = e.target;
                openEditModal(currentText);
            }
        });

        function openEditModal(textItem) {
            document.getElementById('editText').value = textItem.text;
            document.getElementById('editFontSize').value = textItem.fontSize;
            document.getElementById('editColor').value = textItem.fill;
            document.getElementById('editFont').value = textItem.fontFamily;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function saveTextChanges() {
            currentText.set({
                text: document.getElementById('editText').value.toUpperCase(),
                fontSize: parseInt(document.getElementById('editFontSize').value),
                fill: document.getElementById('editColor').value,
                fontFamily: document.getElementById('editFont').value
            });
            canvas.requestRenderAll();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        }

        function saveImage() {
            if (!originalImage) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 2
            });

            const link = document.createElement('a');
            link.download = `ØµÙˆØ±Ø©-Ù…Ø®ØµØµØ©-${Date.now()}.png`;
            link.href = dataURL;
            link.click();
        }

        window.addEventListener('resize', () => {
            if (originalImage) updateCanvasSize(originalImage);
        });
    </script>
</body>
</html>
